<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Web IDE</title>
  <style>
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      font-family: sans-serif;
      background-color: #1e1e1e; /* Dark background for overall app */
      color: #ccc;
    }

    #toolbar {
      background-color: #252526; /* Slightly lighter dark for toolbar */
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: flex-start; /* Align button to the left */
      align-items: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Subtle shadow */
    }

    #toolbar button {
      background-color: #007acc; /* VS Code blue for run button */
      color: white;
      border: none;
      padding: 8px 15px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }

    #toolbar button:hover {
      background-color: #005f99;
    }

    #editor-terminal-split {
      display: flex;
      flex: 1;
      overflow: hidden; /* Prevent overall scrollbars if children overflow */
    }

    #editor-container {
      flex: 3; /* Editor takes more space */
      border-right: 1px solid #333; /* Darker separator */
      background-color: #1e1e1e; /* Match body for seamless look */
      overflow: hidden; /* Monaco handles its own scrolling */
    }

    #terminal-container {
      flex: 2; /* Terminal takes less space */
      background-color: #000; /* Classic terminal black */
      color: #eee; /* Light grey text for readability */
      padding: 5px; /* Reduced padding as xterm handles its own padding */
      box-sizing: border-box;
      /* xterm.js handles its own scrolling, so overflow: hidden is appropriate here */
      overflow: hidden;
      font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace; /* Monospaced font for terminal */
      font-size: 14px;
    }

    /* Style for the xterm.js input line (if needed, xterm handles most of it) */
    .xterm-rows > div > span {
      white-space: pre-wrap; /* Ensure text wraps */
      word-break: break-all; /* Break long words */
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <button id="run-button">Run Code</button>
  </div>
  <div id="editor-terminal-split">
    <div id="editor-container"></div>
    <div id="terminal-container"></div>
  </div>

  <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
  <script src="https://unpkg.com/monaco-editor/min/vs/loader.js"></script>
  <script src="https://unpkg.com/browserfs"></script>
  <script src="https://unpkg.com/@stackblitz/webcontainer"></script>
  <script type="module">
    // Ensure xterm.css is loaded for terminal styling
    const xtermCss = document.createElement('link');
    xtermCss.rel = 'stylesheet';
    xtermCss.href = 'https://unpkg.com/xterm/css/xterm.css';
    document.head.appendChild(xtermCss);

    let editor; // Declare editor globally
    let webContainerInstance; // Declare webContainerInstance globally
    let shellProcess; // To hold the active shell process

    // Initialize Monaco Editor
    require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor/min/vs' }});
    require(['vs/editor/editor.main'], function() {
      editor = monaco.editor.create(document.getElementById('editor-container'), {
        value: '// Write your Node.js code here...\nconsole.log("Hello from Web IDE!");',
        language: 'javascript',
        theme: 'vs-dark' // Force dark mode
      });

      // Adjust editor layout on window resize
      window.addEventListener('resize', () => {
        editor.layout();
      });
    });

    // Set Up xterm.js Terminal
    const terminal = new Terminal({
      cursorBlink: true,
      convertEol: true,
      fontFamily: '"Cascadia Code", "Fira Code", "Consolas", monospace', // Apply font to terminal
      fontSize: 14,
      theme: {
        background: '#000000', // Ensure xterm's background is black
        foreground: '#eeeeee', // Light grey text
        cursor: '#eeeeee',
        selection: '#555555'
      }
    });
    terminal.open(document.getElementById('terminal-container'));
    terminal.write('Welcome to the Web IDE!\r\n');
    terminal.write('Initializing WebContainer...\r\n');

    // Handle terminal input
    terminal.onData(e => {
      // Send data to the WebContainer shell process
      if (shellProcess) {
        shellProcess.input.write(e);
      }
    });

    // --- Removed Theme Toggle functionality ---

    // Integrate WebContainers for Node.js Support
    import { WebContainer } from '@stackblitz/webcontainer';

    async function initializeWebContainer() {
      webContainerInstance = await WebContainer.boot();
      terminal.write('WebContainer ready! Type commands below:\r\n');

      // Mount an initial index.js file with the editor content
      await webContainerInstance.mount({
        'index.js': {
          file: {
            contents: editor.getValue()
          }
        }
      });

      // Spawn a shell process for interactive terminal
      shellProcess = await webContainerInstance.spawn('jsh', {
        env: {
          PS1: '\x1b[1;32m$\x1b[0m ' // Green dollar prompt ($)
        }
      });

      // Pipe shell output to the terminal
      shellProcess.output.pipeTo(new WritableStream({
        write(data) {
          terminal.write(data);
        }
      }));

      // Handle shell exit (e.g., if the user types 'exit')
      shellProcess.exit.then((code) => {
        terminal.write(`\r\njsh exited with code ${code}\r\n`);
        shellProcess = null; // Clear the process
      });
    }

    initializeWebContainer(); // Call the async function to boot WebContainer

    // Run Code from Editor
    document.getElementById('run-button').addEventListener('click', async () => {
      if (!webContainerInstance) {
        terminal.write('\r\nWebContainer not ready yet. Please wait...\r\n');
        return;
      }

      // Clear terminal before running
      terminal.write('\x1bc'); // ANSI escape code to clear terminal

      terminal.write('\r\nRunning code...\r\n');
      const codeToRun = editor.getValue();

      // Write the current editor content to a file in the WebContainer
      await webContainerInstance.fs.writeFile('runme.js', codeToRun);

      // Execute the file using Node.js
      const runProcess = await webContainerInstance.spawn('node', ['runme.js']);

      // Pipe output to terminal
      runProcess.output.pipeTo(new WritableStream({
        write(data) {
          terminal.write(data);
        }
      }));

      // Wait for the process to finish
      const exitCode = await runProcess.exit;
      terminal.write(`\r\nCode finished with exit code: ${exitCode}\r\n`);
      terminal.write('\x1b[1;32m$\x1b[0m '); // Show prompt again in green
    });

    // Set Up Virtual File System (BrowserFS) - for persistent browser storage
    BrowserFS.configure({ fs: "IndexedDB", options: {} }, function(err) {
      if (err) {
        console.error("BrowserFS Error:", err);
        terminal.write(`\r\nBrowserFS Error: ${err.message}\r\n`);
        return;
      }
      const fs = BrowserFS.BFSRequire('fs');
      fs.writeFile('/browserfs_test.txt', 'Hello from BrowserFS (persistent storage)!', function(err) {
        if (err) {
          console.error("BrowserFS Write Error:", err);
          terminal.write(`\r\nBrowserFS Write Error: ${err.message}\r\n`);
          return;
        }
        fs.readFile('/browserfs_test.txt', 'utf8', function(err, data) {
          if (err) {
            console.error("BrowserFS Read Error:", err);
            terminal.write(`\r\nBrowserFS Read Error: ${err.message}\r\n`);
            return;
          }
          console.log("BrowserFS content (in browser console):", data);
          terminal.write(`\r\nBrowserFS test file content: ${data}\r\n\r\n`);
        });
      });
    });
  </script>
</body>
</html>
