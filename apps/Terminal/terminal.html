<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Web IDE</title>
  <style>
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      font-family: sans-serif; /* Added a basic font */
    }

    #toolbar {
      background-color: #333;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: flex-end; /* Align button to the right */
      align-items: center;
    }

    #toolbar button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }

    #toolbar button:hover {
      background-color: #0056b3;
    }

    #editor-container, #terminal-container {
      flex: 1;
      display: flex;
    }

    #editor-container {
      width: 70%;
      border-right: 1px solid #555; /* Separator for better visuals */
    }

    #terminal-container {
      width: 30%;
      background-color: #000;
      color: #fff;
      padding: 10px; /* Add some padding to the terminal */
      box-sizing: border-box; /* Include padding in width */
      overflow: auto; /* Enable scrolling for terminal content */
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <button id="theme-toggle">Toggle Theme</button>
  </div>
  <div style="display: flex; flex: 1;"> <div id="editor-container"></div>
    <div id="terminal-container"></div>
  </div>

  <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
  <script src="https://unpkg.com/monaco-editor/min/vs/loader.js"></script>
  <script src="https://unpkg.com/browserfs"></script>
  <script src="https://unpkg.com/@stackblitz/webcontainer"></script>
  <script type="module">
    // Ensure xterm.css is loaded for terminal styling
    const xtermCss = document.createElement('link');
    xtermCss.rel = 'stylesheet';
    xtermCss.href = 'https://unpkg.com/xterm/css/xterm.css';
    document.head.appendChild(xtermCss);

    // Initialize Monaco Editor
    require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor/min/vs' }});
    let editor; // Declare editor globally or in a scope accessible by theme toggle
    require(['vs/editor/editor.main'], function() {
      editor = monaco.editor.create(document.getElementById('editor-container'), {
        value: '// Start coding...',
        language: 'javascript',
        theme: 'vs-dark'
      });
    });

    // Set Up xterm.js Terminal
    const terminal = new Terminal();
    terminal.open(document.getElementById('terminal-container'));
    terminal.write('Welcome to the Web IDE\r\n$ ');

    // Implement Theme Toggle
    document.getElementById('theme-toggle').addEventListener('click', () => {
      if (editor) { // Ensure editor is initialized before trying to change theme
        const currentTheme = editor.getTheme(); // Use editor instance to get theme
        const newTheme = currentTheme.themeName === 'vs-dark' ? 'vs-light' : 'vs-dark'; // Access themeName property
        monaco.editor.setTheme(newTheme);
      }
    });

    // Integrate WebContainers for Node.js Support
    // Note: WebContainer import requires type="module" in the script tag
    import { WebContainer } from '@stackblitz/webcontainer';

    async function initializeWebContainer() {
      const webContainer = await WebContainer.boot();

      await webContainer.mount({
        'index.js': {
          file: {
            contents: 'console.log("Hello from Node.js in the browser");'
          }
        }
      });

      const process = await webContainer.spawn('node', ['index.js']);

      process.output.pipeTo(new WritableStream({
        write(data) {
          terminal.write(data);
        }
      }));
    }

    initializeWebContainer(); // Call the async function

    // Set Up Virtual File System
    BrowserFS.configure({ fs: "IndexedDB", options: {} }, function(err) {
      if (err) return console.error(err);
      const fs = BrowserFS.BFSRequire('fs');
      fs.writeFile('/test.txt', 'Hello World', function(err) {
        if (err) return console.error(err);
        fs.readFile('/test.txt', 'utf8', function(err, data) {
          if (err) return console.error(err);
          console.log("BrowserFS content:", data); // Log to browser console
          terminal.write(`\r\nBrowserFS content: ${data}\r\n$ `); // Output to xterm.js
        });
      });
    });
  </script>
</body>
</html>
